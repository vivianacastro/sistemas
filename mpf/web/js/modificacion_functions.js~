
$(document).ready(function() {
    
    /*
     * Tabla que muestra todos las ordenes que hay en el sistema
     */    
    $("#tablaOrdenes").jqGrid({
        colNames:['#Solicitud','usuario', 'Sede', 'Campus','Edificio',
            'Piso','Espacio', 'Cantidad 1', 'Novedad 1','Cantidad 2',
            'Novedad 2','Cantidad 3','Novedad 3', 'Contacto', 'Estado', 'Fecha'],
        colModel:[ 
            {name:'numero_solicitud',index:'numero_solicitud', width:40, align:"center"}, 
            {name:'usuario',index:'usuario', width:55, align:"center"}, 
            {name:'cod_sede',index:'cod_sede', width:30, align:"center"}, 
            {name:'codigo_campus',index:'codigo_campus', width:30, align:"center"}, 
            {name:'codigo_edificio',index:'codigo_edificio', width:30, align:"center"}, 
            {name:'piso',index:'piso', width:15, align:"center"},
            {name:'espacio',index:'espacio', width:45, align:"center"},
            {name:'cantidad1',index:'cantidad1', width:30, align:"center"},
            {name:'descripcion1',index:'descripcion1', width:45, align:"center"},
            {name:'cantidad2',index:'cantidad2', width:30, align:"center"},
            {name:'descripcion2',index:'descripcion2', width:45, align:"center"},
            {name:'cantidad3',index:'cantidad3', width:30, align:"center"},
            {name:'descripcion3',index:'descripcion3', width:45, align:"center"},
            {name:'contacto',index:'contacto', width:45, align:"center"},
            {name:'estado',index:'estado', width:45, align:"center"},
            {name:'fecha',index:'fecha', width:45, align:"center"}],
    multiselect: true, 
        caption: "Solicitudes de Mantenimiento"  ,
        width: 760,
        height: 400
    });
   
    /**
    * Función que realiza la consulta de una orden  por medio de ajax.
    * @param {string} consulta, Cadena que representa la palabra clave.
    * @returns {data}
    **/
    function buscarSolicitud(consulta)
    {
        var dataResult;

        try {
            $.ajax({
                type: "POST",
                url: "index.php?action=buscar_solicitudes_mantenimiento",
                data: "buscar=" + consulta,
                dataType: "json",
                async: false,
                error: function(error){
                    alert("error petición ajax");
                    console.log(error.toString());
                },
                success: function(data) {
                    dataResult = data;
                    mostrarMensaje(dataResult.mensaje);
                }
            });
            return dataResult;
        }
        catch(ex) {
            alert("ERROR: Ocurrio un error " + ex);
        }
    }



    /**
     * Función que actualiza la tabla en donde se muestran las ordenes que hay
     * registrados en el sistema.
     */    
    function actualizarTablaOrdenes(data) {

        $("#tablaOrdenes").clearGridData();
        $.each(data, function(index, record) {            
            if($.isNumeric(index)) {
                $("#tablaOrdenes").jqGrid('addRowData',index,record);
            }
        });
    }
    
    /**
     * Función que actualiza la tabla en donde se muestran las ordenes que hay
     * registrados en el sistema.
     */    
    function actualizarTablaOrdenesVarios(data) {

        //$("#tablaOrdenes").clearGridData();
        $.each(data, function(index, record) {            
            if($.isNumeric(index)) {
                $("#tablaOrdenes").jqGrid('addRowData',index,record);
            }
        });
    }
    
    /**
     * Se captura el evento cuando de dar click en el boton buscar y se
     * realiza la operacion correspondiente.
     */    
    $("#buscarOrdenes").click(function (e) {

        var vlrinput = $.trim($("#search").val());
        console.log(vlrinput);

        if(vlrinput != ""){
            var data =  buscarSolicitud(vlrinput);
            actualizarTablaOrdenes(data);
            $("#search").val("");
        }
        else{
            mostrarMensaje("Ingrese un valor en el campo de búsqueda");
        }
    });

/******************* Funciones de Eliminar ordenes *******************/    
    /**
     * Función que permite eliminar una o mas ordenes
     * @param {array} data, datos de los proveedores a eliminar.
     */
    function eliminarOrdenes(data) {
        try {

            var jObject = JSON.stringify($.extend({},data));
            
            $.ajax({
                type: "POST",
                url: "index.php?action=eliminar_orden",
                data: {jObject:  jObject},
                dataType: "json",
                error: function(error){
                    alert("error petición ajax");
                    console.log(error.toString());
                },
                success: function(result){  
                    if(result.value == true) {
                        mostrarMensaje(result.mensaje);
                    }
                    else {
                        mostrarMensaje(result.mensaje);
                    }
                }
            });
        } 
        catch(ex) {
            alert("ERROR: Ocurrio un error " + ex);
        }         
    }
    
    /**
     * Se captura el evento cuando de da click en el boton eliminar y se
     * realiza la operacion correspondiente.
     */     
    $("#eliminarOrdenes").click(function() {
        var data = [];
        var idsElementSelect = $("#tablaOrdenes").jqGrid('getGridParam','selarrrow');

        if(idsElementSelect.length > 0 )
        {
            if(confirm("Esta seguro(a) que desea eliminar" 
                    + " las ordenes seleccionadas","Confirmación"))
            {
                $.each(idsElementSelect, function(index, record)
                {
                    data.push($("#tablaOrdenes").jqGrid('getRowData',record));
                });
                console.log(data);                
                eliminarOrdenes(data);
                $("#tablaOrdenes").clearGridData();
            }
        }
        else
        {
            alert("Por favor seleccione una fila");
            return;
        }      
    });

    /**
     * Se captura el evento cuando de da click en el boton eliminar y se
     * realiza la operacion correspondiente solo para el template de usuarios normales limitados en las funciones.
     */     
    $("#eliminarOrdenesNormal").click(function() {
        var data = [];
        var idsElementSelect = $("#tablaOrdenes").jqGrid('getGridParam','selarrrow');
        var elementSelect = $("#tablaOrdenes").jqGrid('getRowData',idsElementSelect);
        var estadoOrden = elementSelect.estado;

        if(idsElementSelect.length > 0 )
        {
            if(estadoOrden == 'Solicitado')
            {
                if(confirm("Esta seguro(a) que desea eliminar" 
                    + " las ordenes seleccionadas","Confirmación"))
                {
                    $.each(idsElementSelect, function(index, record)
                    {
                        data.push($("#tablaOrdenes").jqGrid('getRowData',record));
                    });
                    eliminarOrdenes(data);
                    $("#tablaOrdenes").clearGridData();
                }
            }
            else{
                alert("Solo puede eliminar una orden cuando su estado es Solicitado");
            }
        }
        else
        {
            alert("Por favor seleccione una fila");
            return;
        }      
    });

/*************************Funciones de Modificacion***********************************/     
    /**
     * Se captura el evento cuando de da click en el boton modificar y se
     * realiza la operacion correspondiente.
     */    
    $("#modificarOrdenes").click(function (e) {
        try {      
            var idElementSelect = $("#tablaOrdenes").jqGrid('getGridParam','selarrrow'); 
            
            /*if(idElementSelect.length > 1) {
                alert("Sólo puede ser modificado un elemento a la vez");
            }
            else */if(idElementSelect.length == 0) {
                alert("Selecciona un elemento");
            }
            else {
            	
            	for(i=0;i<idElementSelect.length;i++){
                
                	var elementSelect = $("#tablaOrdenes").jqGrid('getRowData',i);

                	console.log(elementSelect.numero_solicitud);
                
                	var data = buscarSolicitud(elementSelect.numero_solicitud);

                	console.log(data);
                
                }
                
                $.each(data, function(index, record) {
                    if($.isNumeric(index)) {
                        $("#divDialogModificacion").dialog( "open" );
                        $("#divDialogModificacion" ).dialog( "option", "height", /*450*/350 );
                        //$("#campNumeroSolicitud").html(elementSelect.numero_solicitud);
                        $("#descripcion").val("");
                        //$("#descripcion").val(record.descripcion);
                        $("#usuario").val(record.usuario);
                        //$('#selectEstado').val(record.estado);
                        /*if(record.estado == "Solicitado"){
                        	$("#selectEstado option[value='Seleccionar']").remove();
                        }else if(record.estado == "Revisado"){
                        	$("#selectEstado option[value='Seleccionar']").remove();
                        	$("#selectEstado option[value='Solicitado']").remove();
                        }else if(record.estado == "Realizado"){
                        	$("#selectEstado option[value='Seleccionar']").remove();
                        	$("#selectEstado option[value='Solicitado']").remove();
                        	$("#selectEstado option[value='Revisado']").remove();
                        }*/
                        //$('#estadoM').prop('selectedIndex',record.estado);
                    }
                });                                 
            }
        } 
        catch(ex) {
            alert("ERROR: Ocurrio un error " + ex);
        }         
    });
  
    /**
     * Se captura el evento cuando de da click en el boton guardar modificación
     * y se realiza la operacion correspondiente.
     */     
    function guardarModOrdenes()
    {
        try {           
            var idElementSelect = $("#tablaOrdenes").jqGrid('getGridParam','selarrrow');
            
            if($.trim($("#descripcion").val()) == ""){
            	alert("Error, la descripción no puede estar vacía");
            }else if($.trim($("#estado").val()) == "Seleccionar"){
            	alert("Error, seleccione un estado");
            }else{
            
            	var saveData = {}, solicitud = {};
            	
            	for(i=0;i<idElementSelect.length;i++){
            
            		var elementSelect = $("#tablaOrdenes").jqGrid('getRowData',i);

            		//var saveData = {};
            		solicitud[i] = elementSelect.numero_solicitud;

            		/*saveData["solicitud"] = elementSelect.numero_solicitud;
            		saveData["usuario"] = $("#usuario").val();
            		saveData["estado"] = $.trim($("#selectEstado").find(':selected').val());
            		saveData["descripcion"] = $.trim($("#descripcion").val());*/
            	}
            	
            	saveData["solicitud"] = solicitud;
            	saveData["usuario"] = $("#usuario").val();
            	saveData["estado"] = $.trim($("#selectEstado").find(':selected').val());
            	saveData["descripcion"] = $.trim($("#descripcion").val());
            		
            		/*if($.trim($("#descripcion").val()) == ""){
            			alert("Error, la descripción no puede estar vacía");
            		}else{*/
            			//console.log(saveData);      
            	var jObject = JSON.stringify(saveData);

            	$.ajax({
                	type: "POST",
                	url: "index.php?action=actualizar_orden",
                	data: {jObject:  jObject},
                	dataType: "json",
                	error: function(error){
                    	mensaje = "error petición ajax";
                    	console.log(error.toString());
                	},
                	success: function(result){
                    	if(result.value == true) {
                        $("#divDialogModificacion").dialog("close");
                        	alert(result.mensaje);
                        	for(i=0;i<idElementSelect.length;i++){
                        		var elementSelect = $("#tablaOrdenes").jqGrid('getRowData',i);
                        		console.log(elementSelect.numero_solicitud);
                        		var data = buscarSolicitud(elementSelect.numero_solicitud);
                        		/*if(i==0){
                        			$("#tablaOrdenes").clearGridData();
                        		}*/
                        		$('#tablaOrdenes').jqGrid('delRowData',i);
                        		actualizarTablaOrdenesVarios(data);
                        	}
                        	$('#tablaOrdenes').jqGrid('resetSelection');
                    	}
                    	else {
                        alert(result.mensaje);
                    	}
                	}
            	});
            		//}
         	}
        }
        catch(ex)
        {
            alert("ERROR: Ocurrio un error " + ex);
        }        
    }
    
    
    /**
     * Se captura el evento cuando de da click en el boton guardar modificación
     * y se realiza la operacion correspondiente.
     */     
    function enviarCorreo()
    {
        try {           
            var idElementSelect = $("#tablaOrdenes").jqGrid('getGridParam','selarrrow'); 
            
            var elementSelect = $("#tablaOrdenes").jqGrid('getRowData',idElementSelect);

            var saveData = {};

            saveData["solicitud"] = elementSelect.numero_solicitud;
            saveData["usuario"] = $("#usuario").val();
            saveData["estado"] = $.trim($("#selectEstado").find(':selected').val());
            saveData["descripcion"] = $.trim($("#descripcion").val());
            //console.log(saveData);      
            var jObject = JSON.stringify(saveData);

            $.ajax({
                type: "POST",
                url: "index.php?action=enviar_correo",
                data: {jObject:  jObject},
                dataType: "json",
                /*error: function(error){
                    alert("error petición ajax");
                    console.log(error.toString());
                },*/
                success: function(result){
                    if(result.value == true) {
                        alert(result.mensaje);
                    }
                    else {
                        alert(result.mensaje);
                    }
                }
            });
        }
        catch(ex)
        {
            alert("ERROR: Ocurrio un error " + ex);
        }        
    }
    
    /**
     * evento que permite guardar las modificaciones de las ordenes en la ventana modal
     */
    $("#btGuardarModOrdenes").click(function() {  
        if(confirm("Esta seguro(a) que desea guardar" + " los cambios realizados a la orden","Confirmación"))
        {
        		guardarModOrdenes();
        		//enviarCorreo();
        }
    });   
});


