
$(document).ready(function() {
    
    /**
     * Función que permite consultar uno o varios usuarios con acceso al sistema
     * @param {strign} consulta, palabra clave.
     * @returns {data}
     */
    function buscarUsuarioAutorizado(consulta)
    {
        var dataResult;

        try {
            $.ajax({
                type: "POST",
                url: "index.php?action=buscar_autorizados_manejar_sistema",
                data: "buscar=" + consulta,
                dataType: "json",
                async: false,
                error: function(error){
                    alert("error petición ajax");
                    console.log(error.toString());
                },
                success: function(data) {
                    dataResult = data;
                }
            });
            return dataResult;
        }
        catch(ex) {
            alert("ERROR: Ocurrio un error " + ex);
        }
    }

      /**
     * Función que permite consultar uno o varios usuarios con acceso al sistema
     * @param {strign} consulta, palabra clave.
     * @returns {data}
     */
    function buscarUsuarioSistema(consulta) {

        var dataResult;

        try {
            $.ajax({
                type: "POST",
                url: "index.php?action=buscar_usuario_sistema",
                data: "buscar=" + consulta,
                dataType: "json",
                async: false,
                error: function(error){
                    alert("error petición ajax");
                    console.log(error.toString());
                },
                success: function(data) {
                    dataResult = data;
                }
            });
            return dataResult;
        }
        catch(ex) {
            alert("ERROR: Ocurrio un error " + ex);
        }
    }
    
    /*
     * Tabla que muestra todos los usuarios con acceso al sistema 
     * que hay en registrados.
     */    
    $("#tablaUsuarios").jqGrid({
        colNames:['Id', 'Nombre','Login','Perfil','Correo', 'Telefono','Extension'],
        colModel:[ 
            {name:'id',index:'id', width:30, align:"center"},
            {name:'nombre_usuario',index:'nombre_usuario', width:90, align:"center"},
            {name:'login',index:'login', width:55, align:"center"}, 
            {name:'perfil',index:'perfil', width:60, align:"center"},
            {name:'correo',index:'correo', width:70, align:"center"},
            {name:'telefono',index:'telefono', width:50, align:"center"},
            {name:'extension',index:'extension', width:50, aligan:"center"}
        ],
	multiselect: true, 
        caption: "Usuarios del sistema"  ,
        width: 760,
        height: 160
    });   
    
    /**
     * Función que actualiza la tabla en donde se muestran los usuarios con 
     * acceso al sistema registrados.
     */      
    function actualizarTablaUsuariosAutorizados(data) {
        
        if(data == null) {data = buscarUsuarioAutorizado("");} 

        $("#tablaUsuarios").clearGridData();
        $.each(data, function(index, record) {            
            if($.isNumeric(index)) {
                $("#tablaUsuarios").jqGrid('addRowData',index,record);
            }
        });
    }    
    
    /**
     * Función que se ejecuta al momento que se accede a la página que lo tiene
     * incluido.
     * @returns {undefined}
    */    
    (function () {
        actualizarTablaUsuariosAutorizados();     
    })();   
    
    /**
     * Se captura el evento cuando de dar click en el boton crear_usuario y se
     * realiza la operacion correspondiente.
     */     
    $("#crear_usuario").click(function () {
        try {           
            var nombre_usuario = $.trim($("#nombre_usuario").val());
            var login = $.trim($("#login").val());
            var password = $.trim($("#password").val());
            var r_password = $.trim($("#r_password").val());
            var perfil = $.trim($("#perfil").find(':selected').val());
            var correo = $.trim($("#correo").val());
            var telefono = $.trim($("#telefono").val());
            var extension = $.trim($("#extension").val());
                        
            if(nombre_usuario == '' || login == '' || password == '' || r_password == '' || perfil == '' || correo == '' || telefono == '' || extension == '') {
                alert("Por favor llene todos los campos.");
                return false;
            }
            
            var saveData = {};
            saveData["nombre_usuario"] = nombre_usuario;
            saveData["login"] = login;
            
            if(password == r_password) {
                saveData["password"] = password;
                $("#div_r_password").html("<font color='red'>*</font>Repita la contraseña:");
            } else {
                $("#div_r_password").html("<font color='red'>*</font>Repita la contraseña:");
                $("#div_r_password").append("<br /><font color='red'>\n\
                                No coincide con la contrase&ntilde;a</font>");
                return false;
            }
            saveData["perfil"] = perfil;
            saveData["correo"] = correo;
            saveData["telefono"] = telefono;
            saveData["extension"] = extension;

            console.log(saveData);
            
            var jObject = JSON.stringify(saveData);
            $.ajax({
                type: "POST",
                url: "index.php?action=crear_usuario_autorizado_para_adm_sistema",
                data: {jObject:  jObject},
                dataType: "json",
                error: function(error){
                    alert("error petición ajax");
                    console.log(error.toString());s
                },
                success: function(result){
                    if(result.value == true) {
                        actualizarTablaUsuariosAutorizados();
                        mostrarMensaje(result.mensaje);
                        $("#nombre_usuario").val('');
                        $("#login").val('');
                        $("#password").val('');
                        $("#r_password").val('');
                        $("correo").val('');
                        $("#telefono").val('');
                        $("#extension").val('');
                    }
                    else {
                        mostrarMensaje(result.mensaje);
                    }
                }
            });
        } catch(ex) {
            alert("ERROR: Ocurrio un error " + ex);
        }        
    });
    
    /**
     * Se captura el evento cuando de dar click en el boton crear_usuario y se
     * realiza la operacion correspondiente.
     *     
    $("#crear_usuario_nuevo").click(function () {
        try {           
            var nombre_usuario = $.trim($("#nombre_usuario_n").val());
            var login = $.trim($("#login_n").val());
            var password = $.trim($("#password_n").val());
            var r_password = $.trim($("#r_password_n").val());
            var perfil = "normal";
            var correo = $.trim($("#correo_n").val());
            var telefono = $.trim($("#telefono_n").val());
            var extension = $.trim($("#extension_n").val());
                        
            if(nombre_usuario == '' || login == '' || password == '' || r_password == '' || correo == '' || telefono == '' || extension == '') {
                alert("Por favor llene todos los campos.");
                return false;
            }
            
            var saveData = {};
            saveData["nombre_usuario"] = nombre_usuario;
            saveData["login"] = login;
            
            if(password == r_password) {
                saveData["password"] = password;
                $("#div_r_password").html("<font color='red'>*</font>Repita la contraseña:");
            } else {
                $("#div_r_password").html("<font color='red'>*</font>Repita la contraseña:");
                $("#div_r_password").append("<br /><font color='red'>\n\
                                No coincide con la contrase&ntilde;a</font>");
                return false;
            }
            saveData["perfil"] = perfil;
            saveData["correo"] = correo;
            saveData["telefono"] = telefono;
            saveData["extension"] = extension;

            console.log(saveData);
            var jObject = JSON.stringify(saveData);

            
            $.ajax({
                type: "POST",
                url: "index.php?action=crear_cuenta_usuario",
                data: {jObject:  jObject},
                dataType: "json",
                error: function(request, status, error){
                    alert("Error: petición ajax");
                    console.log(error.toString());
                },
                success: function(result){
                    if(result.value == true)
                    {
                        alert(result.mensaje);
                        location.href = "http://localhost/mantenimiento/web/index.php";
                    }
                    else {
                        mostrarMensaje(result.mensaje);
                    }
                }
            });
        } catch(ex) {
            alert("ERROR: Ocurrio un error " + ex);
        }        
    });


    /**
     * Función que permite eliminar uno o varios usuarios con acceso al sistema
     a.
     * @param {array} data, datos de los usuarios a eliminar.
     */
    function eliminarUsuarioAutorizado(data) {
        try {           
            var jObject = JSON.stringify($.extend({},data));
            console.log(jObject);  
            
            $.ajax({
                type: "POST",
                url: "index.php?action=eliminar_usuario_autorizado_adm_sistema",
                data: {jObject:  jObject},
                dataType: "json",
                error: function(error){
                    alert("error petición ajax");
                    console.log(error.toString());
                },
                success: function(result){  
                    if(result.value == true) {
                        mostrarMensaje(result.mensaje);
                        actualizarTablaUsuariosAutorizados();
                    }
                    else {
                        mostrarMensaje(result.mensaje);
                    }
                }
            });
        } 
        catch(ex) {
            alert("ERROR: Ocurrio un error " + ex);
        }          
    }
    
    /**
     * Se captura el evento cuando de da click en el boton eliminar y se
     * realiza la operacion correspondiente.
     */      
    $("#eliminarUsuarioAutorizado").click(function() {
        var data = [];
        var idsElementSelect = $("#tablaUsuarios").jqGrid('getGridParam','selarrrow');

        if (idsElementSelect.length > 0) { 
            if(confirm("Esta seguro(a) que desea eliminar" 
                    + " los usuario seleccionados","Confirmación")) {
                $.each(idsElementSelect, function(index, record) {
                    data.push($("#tablaUsuarios").jqGrid('getRowData',record));
                });                   
                eliminarUsuarioAutorizado(data);
            }                      
        } else { 
            alert("Por favor seleccione una fila"); 
            return;
        }      
    });
    
    /**
     * Se captura el evento cuando de da click en el boton modificar y se
     * realiza la operacion correspondiente.
     */    
    $("#modificarUsuarioAutorizado").click(function() {
        try {      
            
            var idElementSelect = $("#tablaUsuarios")
                    .jqGrid('getGridParam','selarrrow'); 
                    
            if(idElementSelect.length > 1) {
                alert("Sólo puede ser modificado un usuario a la vez");
            }
            else if(idElementSelect.length == 0) {
                alert("Selecciona un usuario");
            }
            else {
                
                var elementSelect = $("#tablaUsuarios").jqGrid('getRowData',idElementSelect);
                console.log(elementSelect.id);
                
                var data = buscarUsuarioAutorizado(elementSelect.id);

                $.each(data, function(index, record) {
                    if($.isNumeric(index)) {
                        $("#divDialogModificacion").dialog("open");
                        $("#divDialogModificacion").dialog("option", "height", 400);
                        $("#campId").html(elementSelect.id);
                        $("#campUsuario").html(record.nombre_usuario);
                        $("#campLogin").html(record.login);
                        $("#mod_perfil").val(record.perfil);
                    }
                });   
            }
        } catch(ex) {
            alert("ERROR: Ocurrio un error");
        }
    });
    
    /**
     * Función que permite modificar los datos de un usuario con acceso al
     * sistema.
     */     
    function guardarModUsuarioAutorizado() {
        try {           
            
            var idElementSelect = $("#tablaUsuarios")
                    .jqGrid('getGridParam','selarrrow'); 
            var elementSelect = $("#tablaUsuarios")
                    .jqGrid('getRowData',idElementSelect);            

            var saveData = {};
            saveData["id"] = elementSelect.id;
            saveData["perfil"] = $("#mod_perfil").find(':selected').val();   

            var jObject = JSON.stringify(saveData);
            $.ajax({
                type: "POST",
                url: "index.php?action=modificar_perfil_usuario_autorizado_adm_sistema",
                data: {jObject:  jObject},
                dataType: "json",
                error: function(error){
                    alert("error petición ajax");
                    console.log(error.toString());
                },
                success: function(result){
                    if(result.value == true) {
                        $("#divDialogModificacion").dialog("close");
                        actualizarTablaUsuariosAutorizados();
                        mostrarMensaje(result.mensaje);                        
                    }
                    else {
                        mostrarMensaje(result.mensaje);
                    }
                }
            });
        } catch(ex) {
            alert(ex);
        }        
    }
    
    /**
     * Se captura el evento cuando de da click en el boton guardar modificación
     * y se realiza la operacion correspondiente.
     */      
    $("#btGuardarModUsuarioAutorizado").click(function() {    
        if(confirm("Esta seguro(a) que desea guardar" 
                + " los cambios realizados al usuario","Confirmación")) {
            guardarModUsuarioAutorizado();
        } 
    });    
    
    /*------------------------------------------------------------------------*/
    /*------------------------Actualizar Datos-------------------------------*/

    /**
     * Se captura el evento cuando de da click en el guardar cambio.
     * y se realiza la operacion correspondiente.
     */ 
    
    function cambiarDatos() {
        try {
            
            var act_password = $("#act_password").val();
            var password = $("#password").val();
            var r_password = $("#r_password").val();
            var correo = $("#correo").val();
            var telefono = $("#telefono").val();
            var extension = $("#extension").val();
            
            //validar campos null
            if(act_password == '' & password == '' & r_password == '' & 
                correo == '' & telefono == '' & extension == '') {
                alert("Por favor llene todos los campos");
                return false;
            }

            var saveData = {};

            saveData["act_password"] = act_password;

            //validar contraseña
            if(password == r_password) {
                 saveData["password"] = password;
                 $("#div_r_password").html("<font color='red'>*</font>Repita la contraseña:");
            } else {
                $("#div_r_password").html("<font color='red'>*</font>Repita la contraseña:");
                $("#div_r_password").append("<br /><font color='red'>\n\
                                No coincide con la contrase&ntilde;a</font>");
                return false;
            }

            saveData["correo"] = correo;
            saveData["telefono"] = telefono;
            saveData["extension"] = extension;
            console.log(saveData);
            var jObject = JSON.stringify(saveData);

            $.ajax({
                type: "POST",
                url: "index.php?action=cambiar_datos",
                data: {jObject:  jObject},
                dataType: "json",
                error: function(error){
                    alert("error petición ajax");
                    console.log(error.toString());
                },
                success: function(result){
                    if(result.value == true) {
                        mostrarMensaje(result.mensaje);     
                        $("#act_password").val('');
                        $("#password").val('');
                        $("#r_password").val('');
                        $("#correo").val('');
                        $("#telefono").val('');
                        $("#extension").val('');                        
                    }
                    else {
                        mostrarMensaje(result.mensaje);
                        $("#act_password").val('');
                        $("#password").val('');
                        $("#r_password").val('');
                        $("#correo").val('');
                        $("#telefono").val('');
                        $("#extension").val('');                          
                    }
                }
            });
        } catch(ex) {
            alert(ex);
        }        
    }
    
    /**
     * Se captura el evento cuando de da click en el boton cambiar datos
     * y se realiza la operacion correspondiente.
     */     
    $("#cambiar_datos").click(function () {
        if(confirm("Esta seguro(a) que desea realizar" 
                + " los cambios en su datos de usuario","Confirmación")) {
            cambiarDatos();
        }       
    });

    /**
     * se captura el evento cuando se da click en el boton buscar y se realiza la accion correspondiente
     */
    $("#buscarUsuarioAutorizado").click(function (e) {
        try{
            var vlr = $.trim($("#search").val());

            if(vlr == ""){
                alert("Ingrese un valor en el campo de busqueda no puede estar vacio.");
            }
            else{
                var data = buscarUsuarioSistema(vlr);
                actualizarTablaUsuariosAutorizados(data)
            }
        }
        catch(ex)
        {
            alert(ex.toString());
        }
    });

    /**
     * eventos para controlar lo que se muestra en la vista del modulo de usuario
     */
    $("#divCrearNuevoUsuario").hide();

    /**
     * eventos para controlar lo que se muestra en la vista del modulo de usuario 
     */
    $("#crearUsuarioAutorizado").click(function (e) {

        $(this).hide();
        $("#divBusqueda").hide();
        $(".divBotonOpcionU").hide(); 
        $("#divCrearNuevoUsuario").show();
        
    });

});


